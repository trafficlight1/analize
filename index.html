<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lviv Street Analyzer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700;900&family=DM+Mono:wght@400;500&family=Mulish:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --black:   #050505;
    --dark:    #0a0a0a;
    --dark2:   #111111;
    --dark3:   #181818;
    --border:  #202020;
    --border2: #2a2a2a;
    --text:    #f0f0f0;
    --muted:   #505050;
    --muted2:  #363636;
    --yellow:  #d4f000;

    /* Vivid, high-contrast palette */
    --c-magistral:    #ff4560;
    --c-active:       #ffa733;
    --c-green:        #36d98e;
    --c-residential:  #58b4ff;
    --c-unclassified: #2e2e2e;

    --sidebar: 360px;
    --header:  54px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Mulish', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100vh;
    display: grid;
    grid-template-columns: var(--sidebar) 1fr;
    grid-template-rows: var(--header) 1fr;
    overflow: hidden;
  }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ─── HEADER ─────────────────────────── */
  header {
    grid-column: 1 / -1;
    background: var(--black);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
  }
  .logo-block {
    display: flex; align-items: center;
    padding-right: 20px;
    border-right: 1px solid var(--border);
    height: 100%;
  }
  .logo-block img { height: 22px; width: auto; }
  .header-meta {
    padding: 0 20px;
    display: flex; align-items: center; gap: 10px;
  }
  .header-dot-row {
    display: flex; align-items: center; gap: 6px;
    font-family: 'Unbounded', sans-serif;
    font-size: 8.5px; font-weight: 400;
    letter-spacing: 0.2em; color: var(--yellow);
    text-transform: uppercase;
  }
  .header-dot-row::before {
    content: ''; width: 5px; height: 5px;
    background: var(--yellow); border-radius: 50%;
    flex-shrink: 0; animation: blink 2.5s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .header-sep { width: 1px; height: 18px; background: var(--border2); }
  .header-sub { font-size: 10px; color: var(--muted); font-weight: 400; letter-spacing: 0.04em; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  #file-name {
    font-family: 'DM Mono', monospace;
    font-size: 10px; color: var(--muted);
    max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* ─── SIDEBAR ─────────────────────────── */
  .sidebar {
    background: var(--dark);
    border-right: 1px solid var(--border);
    overflow-y: auto; scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    display: flex; flex-direction: column;
  }

  .sb-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }
  .sb-heading {
    font-family: 'Unbounded', sans-serif;
    font-size: 7px; font-weight: 400;
    letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 12px;
  }

  /* ─── PAGE TITLE ──────────────────────── */
  .page-title-block { padding: 22px 16px 18px; border-bottom: 1px solid var(--border); }
  .page-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 21px; font-weight: 900;
    line-height: 1.18; letter-spacing: -0.02em; color: var(--text);
  }
  .page-title span { color: var(--yellow); }

  /* ─── METRIC CARDS ────────────────────── */
  .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
  .metric-card {
    background: var(--dark2); border: 1px solid var(--border);
    border-radius: 3px; padding: 11px 13px;
    position: relative; overflow: hidden;
    transition: border-color 0.2s;
  }
  .metric-card:hover { border-color: var(--border2); }
  .metric-card::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--ac, var(--border2)) 50%, transparent);
  }
  .metric-card.full-width { grid-column: 1 / -1; }
  .metric-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 6.5px; font-weight: 400;
    letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 7px;
  }
  .metric-value {
    font-family: 'Unbounded', sans-serif;
    font-size: 20px; font-weight: 900;
    line-height: 1; color: var(--text); letter-spacing: -0.02em;
  }
  .dist-bar-wrap { margin-top: 10px; }
  .dist-bar { display: flex; height: 2px; gap: 2px; }
  .dist-bar div { transition: width 0.5s ease; border-radius: 1px; }

  /* ─── BIG PRESET BUTTON ───────────────── */
  .preset-mega-wrap {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
  }
  .preset-mega {
    width: 100%; padding: 14px 20px;
    background: var(--yellow);
    border: none; border-radius: 3px;
    font-family: 'Unbounded', sans-serif;
    font-size: 10px; font-weight: 700;
    letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--black);
    cursor: pointer; position: relative; overflow: hidden;
    transition: transform 0.15s, box-shadow 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .preset-mega::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.35) 50%, transparent 100%);
    transform: translateX(-100%);
    animation: shimmer 2.8s infinite;
  }
  @keyframes shimmer {
    0%   { transform: translateX(-100%); }
    45%  { transform: translateX(100%); }
    100% { transform: translateX(100%); }
  }
  .preset-mega:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(212,240,0,0.22); }
  .preset-mega:active { transform: translateY(0); }
  .preset-mega.applied {
    background: transparent;
    border: 1px solid var(--yellow);
    color: var(--yellow);
  }
  .preset-mega.applied::before { display: none; }
  .preset-mega .star { font-size: 13px; }

  /* ─── COLLAPSIBLE SECTION ─────────────── */
  .collapse-section { border-bottom: 1px solid var(--border); }
  .collapse-toggle {
    width: 100%; padding: 14px 16px;
    background: none; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.12s;
  }
  .collapse-toggle:hover { background: rgba(255,255,255,0.02); }
  .collapse-toggle-left {
    display: flex; align-items: center; gap: 10px;
  }
  .collapse-icon {
    width: 20px; height: 20px; border-radius: 2px;
    background: var(--dark3); border: 1px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--muted); flex-shrink: 0;
    transition: background 0.12s;
  }
  .collapse-toggle-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 8px; font-weight: 600;
    letter-spacing: 0.2em; text-transform: uppercase; color: var(--text);
  }
  .collapse-arrow {
    font-size: 10px; color: var(--muted);
    transition: transform 0.25s;
  }
  .collapse-toggle.open .collapse-arrow { transform: rotate(180deg); }
  .collapse-toggle.open .collapse-icon { background: rgba(212,240,0,0.08); border-color: var(--yellow); color: var(--yellow); }

  .collapse-body {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1);
  }
  .collapse-body.open { max-height: 2000px; }

  /* ─── LEGEND ──────────────────────────── */
  .legend-list { display: flex; flex-direction: column; gap: 4px; }
  .legend-row {
    display: flex; align-items: center; gap: 10px;
    padding: 7px 12px;
    background: var(--dark2); border: 1px solid var(--border);
    border-radius: 3px; transition: border-color 0.12s;
  }
  .legend-row:hover { border-color: var(--border2); }
  .legend-line { width: 14px; height: 2px; border-radius: 1px; flex-shrink: 0; }
  .legend-name { font-size: 11px; color: var(--text); flex: 1; font-weight: 500; }
  .legend-n { font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; color: var(--text); }

  /* ─── OPACITY ─────────────────────────── */
  .opacity-list { display: flex; flex-direction: column; gap: 8px; }
  .op-row { display: flex; align-items: center; gap: 8px; }
  .op-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .op-name { font-size: 10px; color: var(--muted); flex: 0 0 100px; }
  .op-track { flex: 1; }
  .op-val { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); min-width: 30px; text-align: right; }

  input[type=range].op-slider {
    -webkit-appearance: none; width: 100%; height: 2px;
    border-radius: 1px; outline: none; cursor: pointer;
    background: var(--dark3);
  }
  input[type=range].op-slider.filled {
    background: linear-gradient(to right, var(--tc) 0%, var(--tc) var(--fp), var(--dark3) var(--fp), var(--dark3) 100%);
  }
  input[type=range].op-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%;
    background: var(--tc,#fff); border: 2px solid var(--dark); cursor: pointer; transition: transform 0.12s;
  }
  input[type=range].op-slider::-webkit-slider-thumb:hover { transform: scale(1.3); }

  /* ─── TABS ────────────────────────────── */
  .tabs {
    display: flex; border-bottom: 1px solid var(--border);
    overflow-x: auto; scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    background: none; border: none; border-bottom: 2px solid transparent;
    padding: 10px 12px 9px;
    font-family: 'Mulish', sans-serif;
    font-size: 10px; font-weight: 700;
    letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--muted); cursor: pointer;
    transition: color 0.12s, border-color 0.12s;
    white-space: nowrap; flex-shrink: 0;
  }
  .tab:hover { color: var(--text); }
  .tab[data-type="magistral"].active   { color: var(--c-magistral);   border-bottom-color: var(--c-magistral); }
  .tab[data-type="active"].active      { color: var(--c-active);      border-bottom-color: var(--c-active); }
  .tab[data-type="green"].active       { color: var(--c-green);       border-bottom-color: var(--c-green); }
  .tab[data-type="residential"].active { color: var(--c-residential); border-bottom-color: var(--c-residential); }

  /* ─── PANELS ──────────────────────────── */
  .panels { padding: 0 16px; }
  .panel { display: none; padding: 14px 0 10px; }
  .panel.active { display: block; }

  .type-desc {
    font-size: 11px; color: var(--muted); line-height: 1.6;
    margin-bottom: 14px; padding: 9px 12px;
    background: var(--dark2); border-left: 2px solid var(--border2);
    border-radius: 0 3px 3px 0;
  }
  .type-desc b { color: var(--text); font-weight: 700; }
  .type-desc .cond {
    margin-top: 4px; font-size: 9px;
    font-family: 'DM Mono', monospace; color: var(--muted2);
  }

  .sg { margin-bottom: 16px; }
  .sg-head { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 7px; }
  .sg-left { display: flex; flex-direction: column; gap: 2px; }
  .sg-op { font-size: 8px; color: var(--muted); letter-spacing: 0.14em; text-transform: uppercase; font-family: 'DM Mono', monospace; }
  .sg-name { font-size: 12px; color: var(--text); font-weight: 600; }
  .sg-chip {
    padding: 4px 9px; border-radius: 2px;
    font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 600;
    background: var(--dark3); border: 1px solid var(--border2);
    min-width: 68px; text-align: center; line-height: 1.4;
  }
  .sg-key { font-family: 'DM Mono', monospace; font-size: 8px; color: var(--muted2); margin-top: 5px; opacity: 0.7; }

  input[type=range].ms {
    -webkit-appearance: none; width: 100%; height: 2px;
    border-radius: 1px; outline: none; cursor: pointer;
    background: var(--dark3);
  }
  input[type=range].ms.filled {
    background: linear-gradient(to right, var(--tc) 0%, var(--tc) var(--fp), var(--dark3) var(--fp), var(--dark3) 100%);
  }
  input[type=range].ms::-webkit-slider-thumb {
    -webkit-appearance: none; width: 13px; height: 13px; border-radius: 50%;
    background: var(--tc,#fff); border: 2px solid var(--dark);
    cursor: pointer; transition: transform 0.12s;
  }
  input[type=range].ms::-webkit-slider-thumb:hover { transform: scale(1.3); }

  /* ─── PRIORITY ────────────────────────── */
  .priority {
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  }
  .prio-label { font-size: 8px; color: var(--muted); font-family: 'DM Mono', monospace; letter-spacing: 0.1em; text-transform: uppercase; flex-shrink: 0; }
  .prio-chain { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
  .pi { font-size: 9px; font-family: 'DM Mono', monospace; padding: 2px 8px; border-radius: 2px; font-weight: 500; }
  .pa { font-size: 9px; color: var(--border2); }

  /* ─── INFO SECTION ────────────────────── */
  .info-section { padding: 0 16px 16px; flex: 1; }
  .info-type {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 3px;
    font-family: 'DM Mono', monospace; font-size: 9px;
    font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
    margin-bottom: 8px;
  }
  .info-type .dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  .ic { background: var(--dark2); border: 1px solid var(--border); border-radius: 3px; padding: 8px 10px; }
  .ic.full { grid-column: 1/-1; }
  .ick { font-size: 9px; color: var(--muted); margin-bottom: 3px; }
  .icv { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 600; color: var(--text); }
  .icu { font-size: 9px; color: var(--muted); font-weight: 400; margin-left: 2px; }
  .no-data {
    font-size: 11px; color: var(--muted); font-style: italic;
    text-align: center; padding: 16px;
    border: 1px dashed var(--border); border-radius: 3px;
    background: var(--dark2);
  }

  /* ─── MAP ─────────────────────────────── */
  #map { width: 100%; height: 100%; }
  .leaflet-control-zoom a {
    background: var(--dark) !important; color: var(--text) !important;
    border-color: var(--border) !important; border-radius: 2px !important;
  }
  .leaflet-control-zoom a:hover { background: var(--dark2) !important; }
  .leaflet-control-attribution {
    background: rgba(5,5,5,0.8) !important;
    color: var(--muted) !important; font-size: 9px !important;
  }
  .leaflet-control-attribution a { color: var(--muted) !important; }
  /* Hide default Leaflet grid lines if any */
  .leaflet-tile-pane { filter: none; }

  /* ─── LOADING OVERLAY ─────────────────────── */
  #loader {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--black);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 0;
    transition: opacity 0.7s ease, visibility 0.7s ease;
  }
  #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

  /* city grid canvas behind everything */
  #loader-canvas {
    position: absolute; inset: 0;
    opacity: 0.18;
  }

  .loader-inner {
    position: relative; z-index: 2;
    display: flex; flex-direction: column;
    align-items: center; gap: 28px;
    text-align: center;
  }

  /* dot + label */
  .loader-eyebrow {
    display: flex; align-items: center; gap: 7px;
    font-family: 'Unbounded', sans-serif;
    font-size: 8px; font-weight: 400;
    letter-spacing: 0.28em; text-transform: uppercase;
    color: var(--yellow);
  }
  .loader-eyebrow::before, .loader-eyebrow::after {
    content: ''; flex: 1;
    height: 1px; width: 40px;
    background: linear-gradient(90deg, transparent, var(--yellow));
  }
  .loader-eyebrow::after { background: linear-gradient(90deg, var(--yellow), transparent); }

  /* big title */
  .loader-title {
    font-family: 'Unbounded', sans-serif;
    font-size: clamp(28px, 4vw, 52px);
    font-weight: 900; line-height: 1.1;
    letter-spacing: -0.03em; color: var(--text);
  }
  .loader-title span { color: var(--yellow); }

  /* SVG street sketch */
  .loader-svg-wrap {
    width: min(440px, 80vw);
    position: relative;
  }
  .loader-svg-wrap svg { width: 100%; height: auto; display: block; }

  /* each path drawn with dashoffset animation */
  .ld-path {
    fill: none;
    stroke-linecap: round;
    stroke-dasharray: var(--len, 400);
    stroke-dashoffset: var(--len, 400);
    animation: draw-line var(--dur, 1.2s) var(--delay, 0s) cubic-bezier(0.4,0,0.2,1) forwards;
  }
  @keyframes draw-line {
    to { stroke-dashoffset: 0; }
  }

  /* legend dots row */
  .loader-legend {
    display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
    opacity: 0; animation: fade-up 0.5s 2.4s ease forwards;
  }
  .loader-legend-item {
    display: flex; align-items: center; gap: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 10px; color: var(--muted);
    letter-spacing: 0.08em;
  }
  .loader-legend-dot {
    width: 8px; height: 8px; border-radius: 50%;
    animation: pop var(--pd, 0.3s) var(--pdelay, 0s) ease both;
  }
  @keyframes pop {
    0%   { transform: scale(0); opacity: 0; }
    70%  { transform: scale(1.4); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* progress bar */
  .loader-progress-wrap {
    width: min(440px, 80vw);
    opacity: 0; animation: fade-up 0.4s 0.3s ease forwards;
  }
  .loader-progress-label {
    display: flex; justify-content: space-between;
    font-family: 'DM Mono', monospace; font-size: 9px;
    color: var(--muted); margin-bottom: 6px;
    letter-spacing: 0.1em; text-transform: uppercase;
  }
  .loader-bar-track {
    height: 2px; background: var(--dark3);
    border-radius: 1px; overflow: hidden;
  }
  .loader-bar-fill {
    height: 100%; width: 0%;
    background: var(--yellow);
    border-radius: 1px;
    animation: fill-bar 3.2s 0.5s cubic-bezier(0.4,0,0.2,1) forwards;
  }
  @keyframes fill-bar {
    0%   { width: 0%; }
    30%  { width: 35%; }
    60%  { width: 62%; }
    85%  { width: 88%; }
    100% { width: 95%; }
  }
  .loader-bar-fill.complete { animation: fill-complete 0.3s ease forwards; }
  @keyframes fill-complete { to { width: 100%; } }

  @keyframes fade-up {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* status text */
  .loader-status {
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); letter-spacing: 0.12em;
    opacity: 0; animation: fade-up 0.4s 0.5s ease forwards;
  }
  .loader-status span {
    display: inline-block;
    animation: blink-text 1.4s infinite;
  }
  @keyframes blink-text { 0%,100%{opacity:1} 50%{opacity:0.3} }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loader">
  <canvas id="loader-canvas"></canvas>

  <div class="loader-inner">
    <div class="loader-eyebrow">Lviv Street Analyzer</div>

    <div class="loader-title">
      Завантаження<br><span>мапи міста</span>
    </div>

    <!-- animated SVG street sketch -->
    <div class="loader-svg-wrap">
      <svg viewBox="0 0 440 120" xmlns="http://www.w3.org/2000/svg">
        <!-- unclassified base grid -->
        <path class="ld-path" d="M10 60 H430" stroke="#2a2a2a" stroke-width="1" style="--len:420;--dur:0.8s;--delay:0.1s"/>
        <path class="ld-path" d="M10 40 H200 M240 40 H430" stroke="#2a2a2a" stroke-width="1" style="--len:380;--dur:0.8s;--delay:0.2s"/>
        <path class="ld-path" d="M10 80 H180 M260 80 H430" stroke="#2a2a2a" stroke-width="1" style="--len:340;--dur:0.8s;--delay:0.25s"/>
        <path class="ld-path" d="M80 10 V110" stroke="#2a2a2a" stroke-width="1" style="--len:100;--dur:0.6s;--delay:0.3s"/>
        <path class="ld-path" d="M180 10 V110" stroke="#2a2a2a" stroke-width="1" style="--len:100;--dur:0.6s;--delay:0.35s"/>
        <path class="ld-path" d="M280 10 V110" stroke="#2a2a2a" stroke-width="1" style="--len:100;--dur:0.6s;--delay:0.4s"/>
        <path class="ld-path" d="M370 10 V110" stroke="#2a2a2a" stroke-width="1" style="--len:100;--dur:0.6s;--delay:0.45s"/>
        <!-- residential -->
        <path class="ld-path" d="M10 50 H430" stroke="#58b4ff" stroke-width="1.4" style="--len:420;--dur:1s;--delay:0.5s"/>
        <path class="ld-path" d="M10 70 H430" stroke="#58b4ff" stroke-width="1.4" style="--len:420;--dur:1s;--delay:0.6s"/>
        <path class="ld-path" d="M130 10 V110" stroke="#58b4ff" stroke-width="1.4" style="--len:100;--dur:0.7s;--delay:0.65s"/>
        <path class="ld-path" d="M330 10 V110" stroke="#58b4ff" stroke-width="1.4" style="--len:100;--dur:0.7s;--delay:0.7s"/>
        <!-- green -->
        <path class="ld-path" d="M30 55 C80 30, 160 85, 220 55 S350 20, 420 55" stroke="#36d98e" stroke-width="2.2" style="--len:500;--dur:1.1s;--delay:0.9s"/>
        <!-- active -->
        <path class="ld-path" d="M10 60 C60 60, 100 30, 160 60 S260 90, 310 60 S390 30, 430 60" stroke="#ffa733" stroke-width="3" style="--len:600;--dur:1.2s;--delay:1.2s"/>
        <!-- magistral -->
        <path class="ld-path" d="M10 60 H430" stroke="#ff4560" stroke-width="5" style="--len:420;--dur:1s;--delay:1.6s"/>
        <path class="ld-path" d="M220 10 V110" stroke="#ff4560" stroke-width="5" style="--len:100;--dur:0.7s;--delay:1.8s"/>
      </svg>
    </div>

    <!-- legend -->
    <div class="loader-legend">
      <div class="loader-legend-item">
        <div class="loader-legend-dot" style="background:#ff4560;--pdelay:2s"></div>Магістральна
      </div>
      <div class="loader-legend-item">
        <div class="loader-legend-dot" style="background:#ffa733;--pdelay:2.1s"></div>Активна
      </div>
      <div class="loader-legend-item">
        <div class="loader-legend-dot" style="background:#36d98e;--pdelay:2.2s"></div>Зелена
      </div>
      <div class="loader-legend-item">
        <div class="loader-legend-dot" style="background:#58b4ff;--pdelay:2.3s"></div>Житлова
      </div>
    </div>

    <!-- progress -->
    <div class="loader-progress-wrap">
      <div class="loader-progress-label">
        <span>Завантаження даних</span>
        <span id="loader-pct">0%</span>
      </div>
      <div class="loader-bar-track">
        <div class="loader-bar-fill" id="loader-bar"></div>
      </div>
    </div>

    <div class="loader-status">обробка вулиць&nbsp;<span>●</span></div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo-block">
    <img id="logo-img" alt="Lviv Street Analyzer">
  </div>
  <div class="header-meta">
    <div class="header-dot-row">Підсвітити ліхтар</div>
    <div class="header-sep"></div>
    <div class="header-sub">Класифікація вулиць</div>
  </div>
  <div class="header-right">
    <span id="file-name">файл не обрано</span>
  </div>
</header>

<!-- SIDEBAR -->
<div class="sidebar">

  <!-- Title -->
  <div class="page-title-block">
    <div class="page-title">Аналіз<br>вулиць<br><span>морфологічний</span></div>
  </div>

  <!-- Stats -->
  <div class="sb-section">
    <div class="sb-heading">Статистика</div>
    <div class="metric-grid">
      <div class="metric-card" style="--ac:var(--c-magistral)">
        <div class="metric-label">Магістральних</div>
        <div class="metric-value" id="cnt-magistral">—</div>
      </div>
      <div class="metric-card" style="--ac:var(--c-active)">
        <div class="metric-label">Активних</div>
        <div class="metric-value" id="cnt-active">—</div>
      </div>
      <div class="metric-card" style="--ac:var(--c-green)">
        <div class="metric-label">Зелених</div>
        <div class="metric-value" id="cnt-green">—</div>
      </div>
      <div class="metric-card" style="--ac:var(--c-residential)">
        <div class="metric-label">Житлових</div>
        <div class="metric-value" id="cnt-residential">—</div>
      </div>
      <div class="metric-card full-width" style="--ac:var(--muted2)">
        <div class="metric-label">Некласифіковано</div>
        <div class="metric-value" id="cnt-unclassified">—</div>
      </div>
    </div>
    <div class="dist-bar-wrap">
      <div class="dist-bar" id="dist-bar">
        <div style="background:var(--c-magistral);width:0%"></div>
        <div style="background:var(--c-active);width:0%"></div>
        <div style="background:var(--c-green);width:0%"></div>
        <div style="background:var(--c-residential);width:0%"></div>
        <div style="background:var(--c-unclassified);width:100%"></div>
      </div>
    </div>
  </div>

  <!-- BIG PRESET BUTTON -->
  <div class="preset-mega-wrap">
    <button class="preset-mega" id="preset-btn">
      <span class="star">✦</span>
      Застосувати пресет
      <span class="star">✦</span>
    </button>
  </div>

  <!-- COLLAPSIBLE CUSTOM SETTINGS -->
  <div class="collapse-section">
    <button class="collapse-toggle" id="collapse-toggle">
      <div class="collapse-toggle-left">
        <div class="collapse-icon">⚙</div>
        <span class="collapse-toggle-label">Кастомні налаштування</span>
      </div>
      <span class="collapse-arrow">▼</span>
    </button>
    <div class="collapse-body" id="collapse-body">

      <!-- Legend inside -->
      <div class="sb-section" style="border-top:1px solid var(--border)">
        <div class="sb-heading">Легенда</div>
        <div class="legend-list">
          <div class="legend-row">
            <div class="legend-line" style="background:var(--c-magistral)"></div>
            <span class="legend-name">Магістральна</span>
          </div>
          <div class="legend-row">
            <div class="legend-line" style="background:var(--c-active)"></div>
            <span class="legend-name">Активна</span>
          </div>
          <div class="legend-row">
            <div class="legend-line" style="background:var(--c-green)"></div>
            <span class="legend-name">Зелена</span>
          </div>
          <div class="legend-row">
            <div class="legend-line" style="background:var(--c-residential)"></div>
            <span class="legend-name">Житлова</span>
          </div>
          <div class="legend-row">
            <div class="legend-line" style="background:var(--c-unclassified)"></div>
            <span class="legend-name">Некласифіковано</span>
          </div>
        </div>
      </div>

      <!-- Opacity inside -->
      <div class="sb-section">
        <div class="sb-heading">Прозорість шарів</div>
        <div class="opacity-list">
          <div class="op-row">
            <div class="op-dot" style="background:var(--c-magistral)"></div>
            <span class="op-name">Магістральна</span>
            <div class="op-track">
              <input type="range" class="op-slider filled" id="op-magistral"
                min="0" max="1" value="1" step="0.01"
                style="--tc:var(--c-magistral);--fp:100%">
            </div>
            <span class="op-val" id="opv-magistral">100%</span>
          </div>
          <div class="op-row">
            <div class="op-dot" style="background:var(--c-active)"></div>
            <span class="op-name">Активна</span>
            <div class="op-track">
              <input type="range" class="op-slider filled" id="op-active"
                min="0" max="1" value="1" step="0.01"
                style="--tc:var(--c-active);--fp:100%">
            </div>
            <span class="op-val" id="opv-active">100%</span>
          </div>
          <div class="op-row">
            <div class="op-dot" style="background:var(--c-green)"></div>
            <span class="op-name">Зелена</span>
            <div class="op-track">
              <input type="range" class="op-slider filled" id="op-green"
                min="0" max="1" value="1" step="0.01"
                style="--tc:var(--c-green);--fp:100%">
            </div>
            <span class="op-val" id="opv-green">100%</span>
          </div>
          <div class="op-row">
            <div class="op-dot" style="background:var(--c-residential)"></div>
            <span class="op-name">Житлова</span>
            <div class="op-track">
              <input type="range" class="op-slider filled" id="op-residential"
                min="0" max="1" value="1" step="0.01"
                style="--tc:var(--c-residential);--fp:100%">
            </div>
            <span class="op-val" id="opv-residential">100%</span>
          </div>
          <div class="op-row">
            <div class="op-dot" style="background:var(--c-unclassified)"></div>
            <span class="op-name">Некласифіковано</span>
            <div class="op-track">
              <input type="range" class="op-slider filled" id="op-unclassified"
                min="0" max="1" value="1" step="0.01"
                style="--tc:var(--c-unclassified);--fp:100%">
            </div>
            <span class="op-val" id="opv-unclassified">100%</span>
          </div>
        </div>
      </div>

      <!-- Threshold tabs inside -->
      <div class="sb-section" style="padding:0;">
        <div style="padding:14px 16px 0;"><div class="sb-heading">Пороги класифікації</div></div>
        <div class="tabs">
          <button class="tab active" data-type="magistral">Магістраль</button>
          <button class="tab" data-type="active">Активна</button>
          <button class="tab" data-type="green">Зелена</button>
          <button class="tab" data-type="residential">Житлова</button>
        </div>

        <div class="panels">

          <div class="panel active" id="panel-magistral">
            <div class="type-desc">
              <b>Магістральна</b> — широка артерія з розвиненим транспортом.
              <div class="cond">ширина ≥ А  ТА  зупинок ≥ Б  ТА  щільність ≥ В</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімальна (А)</span><span class="sg-name">Ширина вулиці</span></div>
                <div class="sg-chip" id="v-mag-width" style="color:var(--c-magistral)">—</div>
              </div>
              <input type="range" class="ms" id="s-mag-width" min="0" max="100" value="0" step="0.5" style="--tc:var(--c-magistral)">
              <div class="sg-key">street_width_m ≥ A</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімум (Б)</span><span class="sg-name">Зупинок транспорту</span></div>
                <div class="sg-chip" id="v-mag-transit" style="color:var(--c-magistral)">—</div>
              </div>
              <input type="range" class="ms" id="s-mag-transit" min="0" max="50" value="0" step="1" style="--tc:var(--c-magistral)">
              <div class="sg-key">transit_count ≥ Б</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімальна щільність (В)</span><span class="sg-name">Щільність зупинок</span></div>
                <div class="sg-chip" id="v-mag-tdensity" style="color:var(--c-magistral)">—</div>
              </div>
              <input type="range" class="ms" id="s-mag-tdensity" min="0" max="20" value="0.10" step="0.01" style="--tc:var(--c-magistral)">
              <div class="sg-key">transit_density ≥ В (зуп/км)</div>
            </div>
          </div>

          <div class="panel" id="panel-active">
            <div class="type-desc">
              <b>Активна вулиця</b> — комерційно насичена артерія.
              <div class="cond">щільність комерції ≥ А  ТА  кількість об'єктів ≥ Б</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімальна щільність (А)</span><span class="sg-name">Щільність комерції</span></div>
                <div class="sg-chip" id="v-act-density" style="color:var(--c-active)">—</div>
              </div>
              <input type="range" class="ms" id="s-act-density" min="0" max="200" value="57" step="0.5" style="--tc:var(--c-active)">
              <div class="sg-key">commerce_density ≥ А (об/км)</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімум об'єктів (Б)</span><span class="sg-name">Кількість комерц. об'єктів</span></div>
                <div class="sg-chip" id="v-act-count" style="color:var(--c-active)">—</div>
              </div>
              <input type="range" class="ms" id="s-act-count" min="0" max="200" value="0" step="1" style="--tc:var(--c-active)">
              <div class="sg-key">commerce_count ≥ Б</div>
            </div>
          </div>

          <div class="panel" id="panel-green">
            <div class="type-desc">
              <b>Зелена вулиця</b> — простір з переважним озелененням.
              <div class="cond">озеленення % ≥ А  ТА  елементів ≥ Б  ТА  площа парків ≥ В</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімальне покриття (А)</span><span class="sg-name">Покриття озелененням</span></div>
                <div class="sg-chip" id="v-grn-pct" style="color:var(--c-green)">—</div>
              </div>
              <input type="range" class="ms" id="s-grn-pct" min="0" max="100" value="7.5" step="0.5" style="--tc:var(--c-green)">
              <div class="sg-key">green_pct ≥ А (%)</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімум елементів (Б)</span><span class="sg-name">Кількість елементів</span></div>
                <div class="sg-chip" id="v-grn-count" style="color:var(--c-green)">—</div>
              </div>
              <input type="range" class="ms" id="s-grn-count" min="0" max="500" value="0" step="1" style="--tc:var(--c-green)">
              <div class="sg-key">green_count ≥ Б</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">мінімальна площа (В)</span><span class="sg-name">Площа парків</span></div>
                <div class="sg-chip" id="v-grn-park" style="color:var(--c-green)">—</div>
              </div>
              <input type="range" class="ms" id="s-grn-park" min="0" max="50000" value="0" step="10" style="--tc:var(--c-green)">
              <div class="sg-key">park_area_m2 ≥ В (м²)</div>
            </div>
          </div>

          <div class="panel" id="panel-residential">
            <div class="type-desc">
              <b>Житлова вулиця</b> — тиха вузька вулиця з мінімальною комерцією.
              <div class="cond">ширина ≤ А  ТА  щільність комерції ≤ Б</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">максимальна (А)</span><span class="sg-name">Ширина вулиці</span></div>
                <div class="sg-chip" id="v-res-width" style="color:var(--c-residential)">—</div>
              </div>
              <input type="range" class="ms" id="s-res-width" min="0" max="60" value="200" step="0.5" style="--tc:var(--c-residential)">
              <div class="sg-key">street_width_m ≤ А</div>
            </div>
            <div class="sg">
              <div class="sg-head">
                <div class="sg-left"><span class="sg-op">максимальна щільність (Б)</span><span class="sg-name">Щільність комерції</span></div>
                <div class="sg-chip" id="v-res-commerce" style="color:var(--c-residential)">—</div>
              </div>
              <input type="range" class="ms" id="s-res-commerce" min="0" max="200" value="2000" step="0.5" style="--tc:var(--c-residential)">
              <div class="sg-key">commerce_density ≤ Б (об/км)</div>
            </div>
          </div>

        </div><!-- /panels -->
      </div>

      <!-- Priority -->
      <div class="priority">
        <span class="prio-label">Пріоритет</span>
        <div class="prio-chain">
          <span class="pi" style="color:var(--c-magistral);background:#ff456012">Магістраль</span>
          <span class="pa">→</span>
          <span class="pi" style="color:var(--c-active);background:#ffa73312">Активна</span>
          <span class="pa">→</span>
          <span class="pi" style="color:var(--c-green);background:#36d98e12">Зелена</span>
          <span class="pa">→</span>
          <span class="pi" style="color:var(--c-residential);background:#58b4ff12">Житлова</span>
        </div>
      </div>

    </div><!-- /collapse-body -->
  </div><!-- /collapse-section -->

  <!-- Segment info -->
  <div class="info-section">
    <div class="sb-heading" style="padding-top:14px;margin-bottom:8px;">Вибраний сегмент</div>
    <div id="info-content" class="no-data">Клікніть на вулицю на карті</div>
  </div>

</div><!-- /sidebar -->

<div id="map"></div>

<script>
// ═══ LOGO ═════════════════════════════════════
document.getElementById('logo-img').src = 'data:image/png;base64,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';

// ═══ LOADER CANVAS BACKGROUND ════════════════
(function initLoaderCanvas() {
  const canvas = document.getElementById('loader-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let raf;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  const COLORS_C = ['#ff4560','#ffa733','#36d98e','#58b4ff','#2a2a2a'];
  const lines = [];

  for (let i = 0; i < 80; i++) {
    const horiz = Math.random() > 0.45;
    lines.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      len: 40 + Math.random() * 260,
      horiz,
      color: COLORS_C[Math.floor(Math.random() * COLORS_C.length)],
      width: horiz ? (Math.random() < 0.15 ? 3 : 1) : (Math.random() < 0.15 ? 3 : 1),
      progress: Math.random(),
      speed: 0.002 + Math.random() * 0.005,
      alpha: 0.12 + Math.random() * 0.25,
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    lines.forEach(l => {
      l.progress += l.speed;
      if (l.progress > 1.3) {
        l.progress = -0.3;
        l.x = Math.random() * canvas.width;
        l.y = Math.random() * canvas.height;
        l.len = 40 + Math.random() * 260;
      }
      const p = Math.max(0, Math.min(1, l.progress));
      const drawn = p * l.len;
      ctx.beginPath();
      ctx.strokeStyle = l.color;
      ctx.globalAlpha = l.alpha * Math.sin(p * Math.PI);
      ctx.lineWidth = l.width;
      ctx.lineCap = 'round';
      if (l.horiz) {
        ctx.moveTo(l.x, l.y);
        ctx.lineTo(l.x + drawn, l.y);
      } else {
        ctx.moveTo(l.x, l.y);
        ctx.lineTo(l.x, l.y + drawn);
      }
      ctx.stroke();
    });
    ctx.globalAlpha = 1;
    raf = requestAnimationFrame(draw);
  }
  draw();

  // expose stop function
  window._stopLoaderCanvas = () => cancelAnimationFrame(raf);
})();

// ═══ LOADER PERCENTAGE COUNTER ═══════════════
(function loaderCounter() {
  const el = document.getElementById('loader-pct');
  if (!el) return;
  let v = 0;
  const stops = [
    {target:35, speed:18},
    {target:62, speed:14},
    {target:88, speed:10},
    {target:95, speed:6},
  ];
  let si = 0;
  const tick = setInterval(() => {
    if (si >= stops.length) { clearInterval(tick); return; }
    if (v < stops[si].target) {
      v = Math.min(v + 1, stops[si].target);
      el.textContent = v + '%';
    } else { si++; }
  }, 50);
  window._finishLoaderCounter = () => {
    clearInterval(tick);
    let n = parseInt(el.textContent);
    const fin = setInterval(() => {
      n = Math.min(n + 2, 100);
      el.textContent = n + '%';
      if (n >= 100) clearInterval(fin);
    }, 20);
  };
})();

// ═══ MAP ══════════════════════════════════════
const map = L.map('map', {
  zoomControl: false,
  attributionControl: true
}).setView([49.84, 24.02], 13);

L.control.zoom({ position: 'bottomright' }).addTo(map);

// Dark tile without any grid lines
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '© CartoDB',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

let geojsonLayer = null;
let geojsonData  = null;

// ═══ OPACITY ══════════════════════════════════
const OPACITY = { magistral:1, active:1, green:1, residential:1, unclassified:1 };

// ═══ THRESHOLDS ═══════════════════════════════
const T = {
  mag_width:0, mag_transit:0, mag_tdensity:0.10,
  act_density:57, act_count:0,
  grn_pct:7.5, grn_count:0, grn_park:0,
  res_width:200, res_commerce:2000,
};
const PRESET = { ...T };

// ═══ STYLE — vivid palette with clear width hierarchy ════════════
const COLORS  = {
  magistral:    '#ff4560',
  active:       '#ffa733',
  green:        '#36d98e',
  residential:  '#58b4ff',
  unclassified: '#1e1e1e'
};
const WEIGHTS = {
  magistral:    5.5,   // widest — main arteries
  active:       3.8,   // commercial streets
  green:        2.8,   // green corridors
  residential:  1.4,   // thin — quiet streets
  unclassified: 0.8    // barely visible
};
const NAMES   = { magistral:'Магістральна', active:'Активна вулиця', green:'Зелена вулиця', residential:'Житлова вулиця', unclassified:'Некласифіковано' };

function classify(p) {
  const w=p.street_width_m??0, tc=p.transit_count??0, td=p.transit_density??0,
        cd=p.commerce_density??0, cc=p.commerce_count??0,
        gp=p.green_pct??0, gc=p.green_count??0, pa=p.park_area_m2??0;
  if (w>=T.mag_width && tc>=T.mag_transit && td>=T.mag_tdensity) return 'magistral';
  if (cd>=T.act_density && cc>=T.act_count)                       return 'active';
  if (gp>=T.grn_pct && gc>=T.grn_count && pa>=T.grn_park)        return 'green';
  if (w<=T.res_width && cd<=T.res_commerce)                       return 'residential';
  return 'unclassified';
}
function styleF(f) {
  const t=classify(f.properties);
  return { color:COLORS[t], weight:WEIGHTS[t], opacity:OPACITY[t], fillOpacity:0 };
}

function renderMap() {
  if (!geojsonData) return;
  if (geojsonLayer) map.removeLayer(geojsonLayer);
  geojsonLayer = L.geoJSON(geojsonData, {
    style: styleF,
    onEachFeature(feature, layer) {
      layer.on({
        click()      { showInfo(feature.properties); },
        mouseover(e) {
          const t=classify(feature.properties);
          e.target.setStyle({ weight:WEIGHTS[t]+2, opacity:Math.min(1,OPACITY[t]+0.2) });
        },
        mouseout(e)  { geojsonLayer.resetStyle(e.target); }
      });
    }
  }).addTo(map);
  map.fitBounds(geojsonLayer.getBounds(), { padding:[28,28] });
  updateCounts();

  // ── dismiss loader ──
  const bar = document.getElementById('loader-bar');
  if (bar) bar.classList.add('complete');
  if (window._finishLoaderCounter) window._finishLoaderCounter();
  setTimeout(() => {
    if (window._stopLoaderCanvas) window._stopLoaderCanvas();
    const loader = document.getElementById('loader');
    if (loader) loader.classList.add('hidden');
  }, 500);
}

function updateCounts() {
  if (!geojsonData) return;
  const c={magistral:0,active:0,green:0,residential:0,unclassified:0};
  geojsonData.features.forEach(f => c[classify(f.properties)]++);
  const total=geojsonData.features.length||1;
  Object.keys(c).forEach(k => { const el=document.getElementById(`cnt-${k}`); if(el) el.textContent=c[k]; });
  const divs=document.getElementById('dist-bar').querySelectorAll('div');
  ['magistral','active','green','residential','unclassified'].forEach((t,i) => {
    divs[i].style.width=(c[t]/total*100)+'%';
  });
}

function reclassify() {
  if (geojsonLayer) { geojsonLayer.setStyle(styleF); updateCounts(); }
}

// ═══ OPACITY SLIDERS ══════════════════════════
['magistral','active','green','residential','unclassified'].forEach(type => {
  const sl=document.getElementById(`op-${type}`);
  const vl=document.getElementById(`opv-${type}`);
  sl.addEventListener('input', () => {
    const v=parseFloat(sl.value);
    OPACITY[type]=v;
    vl.textContent=Math.round(v*100)+'%';
    sl.style.setProperty('--fp', (v*100).toFixed(1)+'%');
    if (geojsonLayer) geojsonLayer.eachLayer(layer => {
      if (layer.feature && classify(layer.feature.properties)===type)
        layer.setStyle({ opacity:v });
    });
  });
});

// ═══ AUTO-LOAD from data/ ═════════════════════
async function tryAutoLoad() {
  const candidates = ['data/fixed.geojson'];
  for (const path of candidates) {
    try {
      const resp = await fetch(path);
      if (resp.ok) {
        const text = await resp.text();
        loadGeoJSON(text, path.split('/').pop());
        return;
      }
    } catch(e) {}
  }
}

function loadGeoJSON(text, name) {
  try {
    geojsonData = JSON.parse(text);
    document.getElementById('file-name').textContent = name || 'завантажено';
    applyRanges(computeMaxes(geojsonData.features));
    renderMap();
  } catch(e) { alert('Помилка читання GeoJSON'); }
}

// ═══ RANGES ═══════════════════════════════════
function computeMaxes(features) {
  const keys=['street_width_m','transit_count','transit_density','commerce_density','commerce_count','green_pct','green_count','park_area_m2'];
  const mx={}; keys.forEach(k=>mx[k]=0);
  features.forEach(f=>keys.forEach(k=>{
    const v=parseFloat(f.properties[k]);
    if(!isNaN(v)&&v>mx[k]) mx[k]=v;
  }));
  Object.keys(mx).forEach(k=>{
    let m=mx[k]||1;
    const mag=Math.pow(10,Math.floor(Math.log10(m)));
    mx[k]=Math.ceil(m/mag)*mag;
  });
  return mx;
}

function applyRanges(mx) {
  [
    ['s-mag-width','street_width_m'],['s-mag-transit','transit_count'],
    ['s-mag-tdensity','transit_density'],['s-act-density','commerce_density'],
    ['s-act-count','commerce_count'],['s-grn-pct','green_pct'],
    ['s-grn-count','green_count'],['s-grn-park','park_area_m2'],
    ['s-res-width','street_width_m'],['s-res-commerce','commerce_density'],
  ].forEach(([id,key])=>{
    const el=document.getElementById(id); if(!el||mx[key]==null) return;
    const isMax=id==='s-res-width'||id==='s-res-commerce';
    el.max=isMax?mx[key]*1.5:mx[key];
    if(parseFloat(el.value)>parseFloat(el.max)) el.value=el.max;
  });
  refreshAll();
}

// ═══ INFO ═════════════════════════════════════
const FIELDS=[
  {l:'Довжина сегменту',k:'seg_len_m',u:'м'},
  {l:'Ширина вулиці',k:'street_width_m',u:'м'},
  {l:'Відстань ліворуч',k:'dist_left_m',u:'м'},
  {l:'Відстань праворуч',k:'dist_right_m',u:'м'},
  {l:"Комерц. об'єктів",k:'commerce_count',u:''},
  {l:'Щільність комерції',k:'commerce_density',u:'об/км'},
  {l:'Озеленення',k:'green_pct',u:'%'},
  {l:'Елементів озеленення',k:'green_count',u:''},
  {l:'Площа парків',k:'park_area_m2',u:'м²'},
  {l:'Зупинок транспорту',k:'transit_count',u:''},
  {l:'Щільність зупинок',k:'transit_density',u:'зуп/км'},
];

function fv(v){
  if(v==null||v==='') return '—';
  const n=parseFloat(v);
  return isNaN(n)?v:(n%1===0?n:n.toFixed(1));
}

function showInfo(p) {
  const type=classify(p), col=COLORS[type];
  let h=`<div class="info-type" style="background:${col}14;color:${col};border:1px solid ${col}28;">
    <div class="dot" style="background:${col}"></div>${NAMES[type]}</div>
    <div class="info-grid">`;
  FIELDS.forEach(({l,k,u})=>{
    h+=`<div class="ic"><div class="ick">${l}</div><div class="icv">${fv(p[k])}<span class="icu">${u}</span></div></div>`;
  });
  h+='</div>';
  const el=document.getElementById('info-content');
  el.innerHTML=h; el.className='';
}

// ═══ TABS ═════════════════════════════════════
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`panel-${btn.dataset.type}`).classList.add('active');
  });
});

// ═══ COLLAPSIBLE ══════════════════════════════
const collapseToggle = document.getElementById('collapse-toggle');
const collapseBody   = document.getElementById('collapse-body');
collapseToggle.addEventListener('click', () => {
  const isOpen = collapseBody.classList.toggle('open');
  collapseToggle.classList.toggle('open', isOpen);
});

// ═══ MAIN SLIDERS ═════════════════════════════
const SDEFS=[
  {id:'s-mag-width',  vi:'v-mag-width',  k:'mag_width',    u:'м',      d:1},
  {id:'s-mag-transit',vi:'v-mag-transit',k:'mag_transit',  u:'',       d:0},
  {id:'s-mag-tdensity',vi:'v-mag-tdensity',k:'mag_tdensity',u:'зуп/км',d:2},
  {id:'s-act-density',vi:'v-act-density',k:'act_density',  u:'об/км',  d:1},
  {id:'s-act-count',  vi:'v-act-count',  k:'act_count',    u:'',       d:0},
  {id:'s-grn-pct',    vi:'v-grn-pct',    k:'grn_pct',      u:'%',      d:1},
  {id:'s-grn-count',  vi:'v-grn-count',  k:'grn_count',    u:'',       d:0},
  {id:'s-grn-park',   vi:'v-grn-park',   k:'grn_park',     u:'м²',     d:0},
  {id:'s-res-width',  vi:'v-res-width',  k:'res_width',    u:'м',      d:1},
  {id:'s-res-commerce',vi:'v-res-commerce',k:'res_commerce',u:'об/км', d:1},
];

function fc(v,u,d){ const n=parseFloat(v); return (d?n.toFixed(d):Math.round(n))+(u?'\u00a0'+u:''); }

function fillSlider(el) {
  const mn=parseFloat(el.min)||0, mx=parseFloat(el.max)||1, v=parseFloat(el.value);
  el.style.setProperty('--fp',((v-mn)/(mx-mn)*100).toFixed(1)+'%');
  el.classList.add('filled');
}

function refreshAll() {
  SDEFS.forEach(({id,vi,u,d})=>{
    const el=document.getElementById(id); if(!el) return;
    document.getElementById(vi).textContent=fc(el.value,u,d);
    fillSlider(el);
  });
}

SDEFS.forEach(({id,vi,k,u,d})=>{
  const el=document.getElementById(id); if(!el) return;
  el.addEventListener('input',()=>{
    T[k]=parseFloat(el.value);
    document.getElementById(vi).textContent=fc(el.value,u,d);
    fillSlider(el);
    reclassify();
    checkPreset();
  });
});

refreshAll();

// ═══ PRESET ═══════════════════════════════════
function applyPreset() {
  SDEFS.forEach(({id,k,u,d,vi})=>{
    const el=document.getElementById(id); if(!el) return;
    const v=Math.min(PRESET[k],parseFloat(el.max));
    el.value=v; T[k]=v;
    document.getElementById(vi).textContent=fc(v,u,d);
    fillSlider(el);
  });
  reclassify(); checkPreset();
}

function checkPreset() {
  const ok=SDEFS.every(({id,k,d})=>{
    const el=document.getElementById(id); if(!el) return true;
    return parseFloat(parseFloat(el.value).toFixed(d))===parseFloat(parseFloat(PRESET[k]).toFixed(d));
  });
  document.getElementById('preset-btn').classList.toggle('applied',ok);
}

document.getElementById('preset-btn').addEventListener('click', applyPreset);
checkPreset();

tryAutoLoad();
</script>
</body>
</html>
